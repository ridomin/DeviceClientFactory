name: .NET Core

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
    - name: Fetch
      run: git fetch --prune --unshallow
#    - name: Setup .NET Core 3.1.2
#      uses: actions/setup-dotnet@v1
#      with:
#        dotnet-version: 3.1.102
    - name: Build with dotnet
      run: dotnet build --configuration Release
    - name: Test
      run: dotnet test --no-build -c Release
    - name: Pack 
      run: dotnet pack --no-build -c Release Rido.DeviceClientFactory/Rido.DeviceClientFactory.csproj
    
    - name: Install NuGet client
      uses: warrenbuckley/Setup-Nuget@v1

    - name: Add private GitHub registry to NuGet
      run: nuget sources add -name "GPR" -Source https://nuget.pkg.github.com/ridomin/index.json -Username ridomin -Password ${{ secrets.GITHUB_TOKEN }}

    - name: Push generated package to GitHub registry
      run: |
        nuget push ./Rido.DeviceClientFactory/bin/Release/*.nupkg -Source "GPR" -SkipDuplicate
        nuget push ./Rido.DeviceClientFactory/bin/Release/*.snupkg -Source "GPR" -SkipDuplicate